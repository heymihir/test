with pd.ExcelWriter('formatted_pivot.xlsx', engine='xlsxwriter') as excel_writer:
    sheet_name = 'Sheet2'
    gap_between_tables = 3
    workbook = excel_writer.book
    worksheet = workbook.add_worksheet(sheet_name)
    border_style = 1

    title_format = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#FFD700',  # Gold
        'font_color': '#101820',  # Black
        'border': border_style
    })

    header_format = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#4A4A4A',  # Dark Grey
        'font_color': '#FFFFFF',  # White
        'border': border_style
    })

    cell_format = workbook.add_format({
        'font_name': 'Calibri',
        'font_color': '#101820',  # Black
        'border': border_style
    })

    number_format = workbook.add_format({
        'font_name': 'Calibri',
        'font_color': '#101820',
        'border': border_style,
        'num_format': '#,##0'
    })

    total_format = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'bg_color': '#D1D3D4',  # Light Grey
        'font_color': '#101820',  # Black
        'border': border_style,
        'num_format': '#,##0'
    })

    def write_table(dataframe, table_title, start_row):
        num_columns = dataframe.shape[1]
        worksheet.merge_range(start_row, 0, start_row, num_columns - 1, table_title, title_format)
        for col_idx in range(num_columns):
            worksheet.write(start_row + 1, col_idx, dataframe.columns[col_idx], header_format)
        for row_offset, row in enumerate(dataframe.itertuples(index=False), start=start_row + 2):
            is_grand_total = "total" in str(row[0]).lower()
            for col_idx, value in enumerate(row):
                cell_fmt = total_format if is_grand_total else cell_format
                if pd.notna(value) and isinstance(value, (int, float)):
                    cell_fmt = total_format if is_grand_total else number_format
                worksheet.write(row_offset, col_idx, value, cell_fmt)
        return start_row + 2 + dataframe.shape[0]

    next_table_row = write_table(df_gainers, "Pivot Gainers", 0)
    next_table_row += gap_between_tables
    write_table(df_losers, "Pivot Losers", next_table_row)

    max_cols = max(df_gainers.shape[1], df_losers.shape[1])
    for col_idx in range(max_cols):
        max_length = len(str(df_gainers.columns[col_idx])) if col_idx < df_gainers.shape[1] else 0
        for df in [df_gainers, df_losers]:
            if col_idx < df.shape[1]:
                col_width = df.iloc[:, col_idx].astype(str).map(len).max()
                max_length = max(max_length, col_width)
        worksheet.set_column(col_idx, col_idx, max_length + 2)

workbook.close()
print("Excel file 'formatted_pivot.xlsx' has been created.")
