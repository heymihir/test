import pandas as pd
import datacompy

def compare_dataframes_datacompy(df_manual, df_code):
    # Perform comparison using datacompy
    compare = datacompy.Compare(
        df_manual, df_code,
        join_columns="cust_id",  # Key column for comparison
        df1_name="manual",
        df2_name="code"
    )

    # Get column-wise match rates
    match_rates = {
        col: compare.column_stats.loc[col, "match_rate"] * 100
        for col in compare.column_stats.index
    }
    
    # Identify columns with mismatches
    mismatched_cols = [col for col, rate in match_rates.items() if rate < 100]

    if not mismatched_cols:
        return None, match_rates  # No mismatches found

    # Get mismatched rows with only affected columns
    mismatched_df = compare.all_mismatch()
    
    # Keep only cust_id, mismatched columns, and add a flag column
    mismatched_df = mismatched_df[['cust_id'] + mismatched_cols].copy()
    mismatched_df['mismatch_flag'] = mismatched_df.apply(
        lambda row: ', '.join(col for col in mismatched_cols if row[col] != df_manual.set_index("cust_id").loc[row["cust_id"], col]),
        axis=1
    )

    return mismatched_df, match_rates

# Example usage:
# df_result, match_rates = compare_dataframes_datacompy(df_manual, df_code)
# print(match_rates)
# print(df_result)
