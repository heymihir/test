import pandas as pd
import numpy as np

# Sample eop_pivot DataFrame; replace with your actual DataFrame
data = {
    'City': ['Ahmedabad', 'Bangalore', 'Chandigarh', 'Chennai', 'Coimbatore', 'Hyderabad', 'INM', 'Kolkata', 'Mumbai', 'New Delhi', 'Pune', 'Total'],
    'EOP-CUA-MTD-5': [556, 10962, 480, 4590, 1128, 2088, 0, 1675, 9436, 15406, 4805, 50110],
    'EOP-CUA-MTD-6': [575, 12010, 404, 4130, 1111, 1904, 0, 1960, 9319, 18076, 4819, 53624],
    'CUA DailyGrowth': [23, 1049, -83, -167, -2, -198, 0, 285, -115, 2655, 14, 3461],
    'CUA Growth_Vs_ME': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    'EOP-EEFC-MTD-5': [72, 2127, 27, 957, 386, 133, 0, 0, 857, 745, 5754, 5754],
    'EOP-EEFC-MTD-6': [59, 2303, 29, 529, 372, 123, 0, 0, 627, 754, 5264, 5264],
    'EEFC DailyGrowth': [-14, 175, 2, -428, -9, -10, 0, 0, -230, 10, -489, -489],
    'EEFC Growth_Vs_ME': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    'EOP-TMD-MTD': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
}
eop_pivot = pd.DataFrame(data)

num_cols = eop_pivot.shape[1]
group_labels = ['CUA', 'EEFC', 'TMD', 'ASSTES']
group_size = 4

with pd.ExcelWriter('formatted_eop_pivot.xlsx', engine='xlsxwriter') as writer:
    start_data_row = 2
    eop_pivot.to_excel(writer, index=False, sheet_name='Sheet1', startrow=start_data_row, header=False)
    workbook = writer.book
    worksheet = writer.sheets['Sheet1']

    border = 1

    top_merge_fmt = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#D90019',
        'font_color': '#FFFFFF',
        'border': border
    })

    header_fmt = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': '#4A4A4A',
        'font_color': '#FFFFFF',
        'border': border
    })

    cell_fmt = workbook.add_format({
        'font_name': 'Calibri',
        'font_color': '#101820',
        'border': border
    })

    num_fmt = workbook.add_format({
        'font_name': 'Calibri',
        'font_color': '#101820',
        'border': border,
        'num_format': '#,##0'
    })

    neg_num_fmt = workbook.add_format({
        'font_name': 'Calibri',
        'font_color': '#DC143C',
        'border': border,
        'num_format': '#,##0'
    })

    total_row_fmt = workbook.add_format({
        'bold': True,
        'font_name': 'Calibri',
        'bg_color': '#D1D3D4',
        'font_color': '#101820',
        'border': border,
        'num_format': '#,##0'
    })

    # Top merge row (row 0)
    worksheet.write_blank(0, 0, None, top_merge_fmt)
    for group_index, label in enumerate(group_labels):
        start_col = 1 + group_index * group_size
        end_col = min(start_col + group_size - 1, num_cols - 1)
        worksheet.merge_range(0, start_col, 0, end_col, label, top_merge_fmt)

    # Header row (row 1)
    for col_index, col_name in enumerate(eop_pivot.columns):
        worksheet.write(1, col_index, col_name, header_fmt)

    # Data rows (starting row 2)
    for row_idx, row in enumerate(eop_pivot.itertuples(index=False), start=start_data_row):
        is_total = str(row[0]).strip().lower() == 'total'
        for col_idx, value in enumerate(row):
            fmt = cell_fmt
            if pd.notna(value) and isinstance(value, (int, float)):
                if value < 0 and not is_total:
                    fmt = neg_num_fmt
                else:
                    fmt = num_fmt
            if is_total:
                fmt = total_row_fmt
            worksheet.write(row_idx, col_idx, value, fmt)

    # Adjust column widths
    for col in range(num_cols):
        header_text = str(eop_pivot.columns[col])
        max_len = len(header_text)
        for item in eop_pivot.iloc[:, col].astype(str):
            max_len = max(max_len, len(item))
        worksheet.set_column(col, col, max_len + 2)

print("Excel file 'formatted_eop_pivot.xlsx' has been created.")
